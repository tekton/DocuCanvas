{% extends "helpdesknew/base.html" %}

{% block pageTitle %}
Ask A Question
{% endblock %}

{% block contextNav %}
    <li><a href="{% url 'helpdesknew.views.help_form' %}">Ask a Question</a></li>
    <li><a href="{% url 'helpdesknew.views.get_resolved' %}">Resolved Questions</a></li>
    <li><a href="{% url 'helpdesknew.views.get_pending' %}">Unresolved Questions</a></li>
    <li><a href="{% url 'helpdesknew.views.user_help' %}">Your Questions</a></li>
{% endblock %}

{% block additionalHead %}
<style>
#image_upload_preview{
    opacity: 0;
}
#summary_textfield{
    width: 100%;
}
#id_name{
    width: 100%;
}
</style>
{% endblock %}

{% block bodyContent %}

<form action="{% url 'helpdesknew.views.help_form' %}" method="post" enctype="multipart/form-data" class="form-horizontal span6">
    {% csrf_token %}
    <div class="control-group">
        <label class="control-label" for="id_name">Summary (required):</label>
        <div class="controls">{{form.name}}</div>
    </div>
    <div class="control-group">
        <label class="control-label" for="id_question">Description:</label>
        <div class="controls">{{form.question}}</div>
    </div>
    <div class="control-group">
        <label class="control-label">Upload Screenshot(s):</label>
        <div class="controls"><input type="file" name="myfiles" multiple></div>
    </div>
    <div>
        <div class="controls">
            <input type="submit" name='submit' value="Submit" class="btn btn-primary" />
        </div>
    </div>
    <input type='hidden' name="user" id="id_user" value='{{user.id}}'/><br>
    
</form>

<div style="float:right;height:500px;width:500px;border-style:solid;border-width:1px;border-color:#cccccc;font-size: 14px;color: #555555;">
    <table name="similar_questions_results">
    </table>
</div>
{% endblock %}

{% block endScripts %}
<!--<script src="http://code.jquery.com/jquery-1.9.1.js"></script>-->
<script type="text/javascript">
    $(document).ready(function(){
        $('#id_photo').click(function(){
            $('#image_upload_preview').fadeTo("fast", 1);
        });

        $('#id_name').keyup( $.debounce(350, getSimilarQuestions));
    });


    function returnModelLink(html_obj, model_dict){
        var link_obj = $('<a></a>');

        switch(model_dict['model_type'])
        {
            case "Project": 
                link_obj.text(model_dict['name']);
                html_obj.attr('title', model_dict['description']);
                link_obj.attr('href', "/project/" + model_dict['id'] );
                break;
            case "Issue":
                link_obj.text(model_dict['summary']);
                html_obj.attr('title', model_dict['description']);
                link_obj.attr('href', "/issue/" + model_dict['id'] );
                break;
            case "HelpRequest":
                link_obj.text(model_dict['name']);
                html_obj.attr('title', model_dict['question']);
                link_obj.attr('href', "/help/" + model_dict['id'] );
                break;
            case "HelpResponse":
                link_obj.text(model_dict['helprequest']);
                html_obj.attr('title', model_dict['response']);
                link_obj.attr('href', "/help/" + model_dict['id'] );
                break;
            case "FoodRequest":
                link_obj.text(model_dict['item']);
                html_obj.attr('title', model_dict['quantity'] + ' ' + model_dict['quantity_type']);
                link_obj.attr('href', "/food/" + model_dict['id'] );
                break;
            case "Notification":
                link_obj.text(model_dict['message']);
                html_obj.attr('title', model_dict['creator']);
                link_obj.attr('href', "/all/" );
                break;

        }
        return html_obj.append(link_obj);

    }


    function getSimilarQuestions(){
        $.ajax({
                type: 'GET',
                url: '/search/',
                data:{
                    q: $('#id_name').val(),
                    ajax: "Yes",
                },
                success: function(data){
                    
                    $('[name="similar_questions_results"]').empty();
                    for(result in data.results){
                        var similar_search_container = $('<tr></tr>');
                        similar_search = data.results[result];
                        similar_search_container = returnModelLink(similar_search_container, similar_search); 
                        $('[name="similar_questions_results"]').append(similar_search_container);

                    }
                },
                error: function(data){
                    //AlertMessage.error(data.responseJSON.response);
                    console.log(data.responseJSON.response)
                }
            });
    }

    function readImage(input){
        if(input.files && input.files[0]){
            var reader = new FileReader();
            reader.onload = function(e){
                $('#image_upload_preview').attr('src', e.target.result).width('100').height('100');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
{% endblock %}