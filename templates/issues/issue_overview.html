{% extends "base_issues.html" %}
{% load markup %}


{% block extra_head%}
	<script type="text/javascript">
		$(document).ready(function(){
            var issue_id = $('#issue_id').val();
			$('#subscribe_to_issue').click(function(){
            	$.ajax({
				    type:"POST",
				    url:"/issue/subscribe",
				    data:{
				    	issue:"{{issue.id}}"
				    },
				    success: function(data){
				    	// Hides nav menu only after successfull submission
				    	NavMenu.HideAll();	
				    	
				    	alert(data['status']);
				    	if( data['status'] == "Unsubscribing Issue"){
				    		$('#subscribe_to_issue').text("Subscribe");
				    	}
				    	else if(data['status'] == "Successfully subscribed to Issue"){
				    		$('#subscribe_to_issue').text("Unsubscribe");
				    	}
				    },
				    error: function(data){
				    	alert("Server side error");
				    }

				});
        	});

			$('#pin_issue').click(function(e) {
                e.preventDefault();
            	$.get($(this).attr('href'), function(data, status) {
                    // Hides nav menu only after successfull submission
                    NavMenu.HideAll();
                    if ( data.success ) {
                        if ( data.is_pinned ) {
                            $('#pin_issue').text("Unpin");
                            alert( "Issue pinned" );
                        }
                        else {
                            $('#pin_issue').text("Pin");
                            alert( "Issue unpinned" );
                        }
				    }
                    else {
                        alert( "Pinning error: " + data.error )
                    }
				});
                return false;
        	});

        	$('#assign_issue').click(function(){
            	$.ajax({
				    type:"POST",
				    url:"/issue/assign",
				    data:{
				    	issue:"{{issue.id}}",
				    	assign:"assign"
				    },
				    success: function(data){
				    	// Hides nav menu only after successfull submission
				    	NavMenu.HideAll();	

				    	alert(data['status']);
				    	if( data['status'] == "Successfully unassigned issue"){
				    		$('#assign_issue').text("Assign");
				    	}
				    	else if(data['status'] == "Successfully assigned issue" || data['status'] == "Successfully reassigned issue"){
				    		$('#assign_issue').text("Unassign");
				    	}		    	
				    },
				    error: function(data){
				    	alert("Server side error");
				    }

				});
        	});

        	$('#assign_issue_to').click(function(){
            	$.ajax({
				    type:"POST",
				    url:"/issue/assign",
				    data:{
				    	issue:"{{issue.id}}",
				    	assign:"assign_to",
				    	user:$('#assigned_user').val()
				    },
				    success: function(data){
				    	// Hides nav menu only after successfull submission
				    	NavMenu.HideAll();	

				    	alert(data['status']);
				    },
				    error: function(data){
				    	alert("Server side error");
				    }

				});
        	});

        	$('#set_bug_status').click(function(){

        		if( $('#id_status').val() == "fixed"){
					// Hides nav menu
        			NavMenu.HideAll();

        			$('#comment_title').text('Bug Fixed Comment');
        			$('#id_description').focus();
        			$('<input type="hidden" name="issue" value="{{issue.id}}"></input>').insertBefore('#id_description')
        			$('<input type="hidden" name="status" value="fixed"></input>').insertBefore('#id_description')
        			$('#submit_comment_button').val('Fix Bug');

        			$('#submit_comment_button').unbind('click');
        			$('#submit_comment_form').attr('action', '/issue/set_bug_state');

        			$('#submit_comment_button').click(function(){
        				

        				/*$.ajax({
					    type:"POST",
					    url:"/issue/set_bug_state",
					    data:{
					    	issue:"{{issue.id}}",
					    	status:$('#id_status').val()
					    },
					    success: function(data){	
					    	alert(data['status']);
					    },
					    error: function(data){
					    	alert(data['status']);
					    	alert("Server side error");
					    }

						});*/
        			});
        		}

        		else{
	            	$.ajax({
					    type:"POST",
					    url:"/issue/set_bug_state",
					    data:{
					    	issue:"{{issue.id}}",
					    	status:$('#id_status').val()
					    },
					    success: function(data){
					    	// Hides nav menu only after successfull submission
				    		NavMenu.HideAll();	

					    	alert(data['status']);
					    },
					    error: function(data){
					    	alert("Server side error");
					    }

					});
            	}
        	});

		});

	</script>
{% endblock %}

{% block context_nav %}
	<a href="/issue/new/{{issue.project.id}}">New Issue : {{issue.project.name}}</a>

	{% if subscribe == None%}
		<a id="subscribe_to_issue">Subscribe</a>
	{% else %}
		<a id="subscribe_to_issue">Unsubscribe</a>
	{% endif %}

		<a href="/issue/pin/{{ issue.id }}" id="pin_issue">{% if pin %}Unpin{% else %}Pin{% endif %}</a>

	{% if issue.assigned_to == user%}
		<a id="assign_issue">Unassign</a>
	{% else %}
		<a id="assign_issue">Assign</a>
	{% endif %}
	<a>Assign To:  
		<select id="assigned_user">
			{% for user in users%}
				<option value="{{user.id}}">{{user.username}}</option>
			{% endfor%}
		</select>
		<input type="button" id="assign_issue_to" value="Assign"/>
	</a>
	<a>Status:
		{{form.status}}
		<input type="button" id="set_bug_status" value="Set"/>
	</a>
	<a href="/issue/{{issue.id}}/edit">Edit</a>
{% endblock%}

{% block container %}
    <input type="hidden" id="issue_id" value="{{ issue.id }}"/>
	<table class="tbl-generic tbl-overview">
		<tr class="tbl-rowheader">
			<td class="tbl-fauxth">Summary</td>
		</tr>
		<tr>
			<td>{{issue.summary}}</td>
		</tr>
		<tr class="tbl-rowheader">
			<td class="tbl-fauxth">Description</td>
		</tr>
		<tr>
			<td>{{issue.description|markdown:"safe"}}</td>
		</tr>
	</table>
{% endblock %}

{% block spiffy_box_right %}
	<b>Project Name:</b> <a href="/project/{{issue.project.id}}">{{issue.project.name}}</a><br/>
	<b>Meta Issue:</b> {{issue.meta_issues.title}}<br/>
	<b>State:</b> {{issue.state}}<br />
	<b>Projected Start:</b> {{issue.projected_start}}<br/>
	<b>Projected End:</b> {{issue.projected_end}}<br/>
	<b>Actual Start:</b> {{issue.actual_start}}<br />
	<b>Actual End:</b> {{issue.actual_end}}<br />
	<b>Date Reported:</b> {{issue.date_reported}}<br/>
	<b>Created:</b> {{issue.created}}<br/>
	<b>Modified:</b> {{issue.modified}}<br/>
	<b>View Type:</b> {{issue.view_type}}<br/>
	<b>Issue Type:</b> {{issue.issue_type}}<br/>
	<b>Assigned To:</b> <a href="/auth/user/{{issue.assigned_to.id}}">{{issue.assigned_to}}</a><br/>
	<b>Title:</b> {{issue.title}}<br/>
	<b>Link Slug:</b> {{issue.link_slug}}<br/>
	<b>Status:</b> {{issue.status}}<br/>
	<b>Criticality:</b> {{issue.criticality}}<br/>
	<b>Fixability:</b> {{issue.fixability}}<br/>
	<b>R &amp; D:</b> {{issue.r_and_d}}<br/>
	<b>Feature:</b> {{issue.feature}}<br/>
	<b>OS:</b> {{issue.os}}<br/>
	<b>OS Version:</b> {{issue.os_version}}<br/>
	<b>Browser:</b> {{issue.browser}}<br/>
	<b>Browser Version:</b> {{issue.browser_version}}<br/>
	<b>Screen Shot:</b> {{issue.screen_shot}}<br/>
	<b>Wireframe:</b> {{issue.wireframe}}<br/>
	<b>URI to Test:</b> {{issue.uri_to_test}}
{% endblock %}

{% block container_bottom_clear %}
	<table class="tbl-generic tbl-comments">
		<tr>
			<td colspan="2">
				<form action="/issue/comment/{{issue.id}}" id="submit_comment_form" method="post" enctype="multipart/form-data">
					{% csrf_token %}
					<b><a id="comment_title">Comment:</a></b> {{comment_form.errors}} <br />
					<div class="comment_textarea">{{comment_form.description}}</div>
					<input type='hidden' name="issue" id="id_issue" value='{{issue.id}}'/>
					<input type='hidden' name="user" id="id_user" value='{{user.id}}'/>
					<input type="submit" value="Submit" id="submit_comment_button"/>
				</form>
				<br>
			</td>
		</tr>
		{% for comment in comments%}
			<tr class="tbl-rowheader">
				<td class="tbl-fauxth tbl-comments-user"><b>{{comment.user}}</b</td>
				<td class="tbl-fauxth tbl-comments-created">{{comment.created}}</td>
			</tr>
			<tr>
				<td class="tbl-comments-description" colspan="2">{{comment.description|markdown:"safe"}}</td>
			</tr>
		{% endfor %}

	</table>
{% endblock %}