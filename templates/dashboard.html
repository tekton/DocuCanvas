{% extends "base.html" %}
{% load set_var %}

{% block extra_head%}
    <link rel="stylesheet" type="text/css" href="/static/css/dashboard.css"/>
    <script type="text/javascript" src="/static/scripts/ajax_tools.js"></script>
    <script type="text/javascript" src="/static/scripts/__jquery.tablesorter/jquery.tablesorter.js"></script>
    <script type="text/javascript">

        $(document).ready(function() {


            $("#newsfeed").tablesorter({sortList: [[5,0]]} ); 

            $('.subscribe_to_issue').asAjax(function(data) {
                if ( data.success ) {
                    if ( data.is_subscribed ) {
                        alert( "Successfully subscribed to issue" );
                        $(this).find('.add_remove').toggleClass('ui-icon-plusthick', false).toggleClass('ui-icon-closethick', true);
                    }
                    else {
                        alert( "Successfully unsubscribed from issue" );
                        $(this).find('.add_remove').toggleClass('ui-icon-plusthick', true).toggleClass('ui-icon-closethick', false);
                    }
                }
                else {
                    alert( "Error on subscribe: " + data.error );
                }
            });

            $('.pin_issue').asAjax( function(data) {
                if ( data.success ) {
                    if ( data.is_pinned ) {
                        alert( "Successfully pinned issue" );
                        $(this).find('.add_remove').toggleClass('ui-icon-plusthick', false).toggleClass('ui-icon-closethick', true);
                    }
                    else {
                        alert( "Successfully unpinned issue" );
                        $(this).find('.add_remove').toggleClass('ui-icon-plusthick', true).toggleClass('ui-icon-closethick', false);
                    }
                }
                else {
                    alert( "Error on pin: " + data.error );
                }
            });

            $('.assign_issue').asAjax( function(data) {
                if ( data.success ) {
                    if ( data.assigned_to == 'none' ) {
                        alert( "Successfully unassigned issue" );
                        $(this).find('.add_remove').toggleClass('ui-icon-closethick', false).toggleClass('ui-icon-plusthick', true);
                    }
                    else if ( data.assigned_to == 'self' ) {
                        alert( 'Successfully assigned issue' );
                        $(this).find('.add_remove').toggleClass('ui-icon-plusthick', false).toggleClass('ui-icon-closethick', true);
                    }
                }
                else {
                    alert( "Error on assignment: " + data.error );
                }
            });

            $('.add_remove').closest('tr').hover(function() {
                $(this).find('.add_remove').stop(true).hide().fadeIn();
            }, function() {
                $(this).find('.add_remove').fadeOut();
            });

        });

    </script>

{% endblock %}

{% block context_nav %}
    <li><a href="/issue/new">New Issue</a></li>
    <li><a href="/issue/unassigned">Unassigned Issues</a></li>
    <li><a href="/food/all">Food Requests</a></li>
    <li><a href="/reports/edit">Daily Reports</a></li>
    <li><a href="/help/user/{{user.id}}">Help</a></li>
{% endblock %}

{% block container %}
        <div class="dashboard_container_section ">
            <h3>Newsfeed</h3>
            <table class="dashboard_table tbl-generic tbl-dashboard tbl-dashboard-news_feed" id="newsfeed">
                <thead>
                <tr class="tbl-fauxth">
                    <th>User</th>
                    <th>Action</th>
                    <th>Project</th>
                    <th>Item</th>
                    <th>Text</th>
                    <th>Date</th>
                </tr>
                </thead>
                <tbody>
                    {% for newsfeed in newsfeeds%}
                        
                        {% if newsfeed.newsfeed_type == 'update_issue' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td><a href="/project/{{newsfeed.project.id}}">{{newsfeed.project.name}}</a></td>
                                <td><a href="/issue/{{newsfeed.issue.id}}">{{newsfeed.issue.summary}}</a></td>
                                <td>{{newsfeed.field_change|truncatechars:80}} from {{newsfeed.old_value}} to {{newsfeed.new_value}}</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}

                        {% if newsfeed.newsfeed_type == 'create_issue' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td><a href="/project/{{newsfeed.project.id}}">{{newsfeed.project.name}}</a></td>
                                <td><a href="/issue/{{newsfeed.issue.id}}">{{newsfeed.issue.summary}}</a></td>
                                <td>None</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}

                        {% if newsfeed.newsfeed_type == 'comment' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td><a href="/project/{{newsfeed.project.id}}">{{newsfeed.project.name}}</a></td>
                                <td><a href="/issue/{{newsfeed.issue.id}}">{{newsfeed.issue.summary}}</a></td>
                                <td>{{newsfeed.comment|truncatechars:80}}</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}
                        {% if newsfeed.newsfeed_type == 'update_project' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td><a href="/project/{{newsfeed.project.id}}">{{newsfeed.project.name}}</a></td>
                                <td>None</td>
                                <td>None</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}
                        {% if newsfeed.newsfeed_type == 'create_project' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td><a href="/project/{{newsfeed.project.id}}">{{newsfeed.project.name}}</a></td>
                                <td>None</td>
                                <td>None</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}

                        {% if newsfeed.newsfeed_type == 'create_food_request' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td>None</td>
                                <td><a href="/food/{{newsfeed.food.id}}">{{newsfeed.food.item}}</a></td>
                                <td>None</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}
                        {% if newsfeed.newsfeed_type == 'complete_food_request' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td>None</td>
                                <td><a href="/food/{{newsfeed.food.id}}">{{newsfeed.food.item}}</a></td>
                                <td>None</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}
                        {% if newsfeed.newsfeed_type == 'create_checklist' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td><a href="/project/{{newsfeed.project.id}}">{{newsfeed.project.name}}</a></td>
                                <td><a href="/checklist/project/{{newsfeed.project.id}}">{{newsfeed.checklist.name}}</a></td>
                                <td>None</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}
                        {% if newsfeed.newsfeed_type == 'update_checklist' %}
                            <tr>
                                <td><a href="/auth/user/{{newsfeed.user.id}}">{{newsfeed.user}}</a></td>
                                <td><a href="/newsfeed/{{newsfeed.newsfeed_type}}">{{newsfeed.newsfeed_type}}</a></td>
                                <td><a href="/project/{{newsfeed.project.id}}">{{newsfeed.project.name}}</a></td>
                                <td><a href="/checklist/project/{{newsfeed.project.id}}">{{newsfeed.checklist.name}}</a></td>
                                <td>None</td>
                                <td>{{newsfeed.timestamp}}</td>
                            </tr>
                        {% endif %}

                    {% endfor%}
                </tbody>
            </table>
        </div>
        <div class="dashboard_container_section">
            <h3>Assigned</h3>
            <table class="dashboard_table tbl-generic tbl-dashboard">
            {% for issue in issues%}
                {% if newest_assigned != issue.created %}
                    {% set newest_assigned = issue.created %}
                    <tr class="date_header tbl-rowheader"><td class="tbl-fauxth" colspan="4">{{issue.created}}</td></tr>
                {% endif %}

                <tr>
                    <td class="tbl-project"><a href="/project/{{issue.project.id}}">{{issue.project.name}}</a></td>
                    <td class="tbl-summary"><a href="/issue/{{issue.id}}">{{issue.summary}}</a></td>
                    <td class="tbl-assigned_to"><a href="/auth/user/{{issue.assigned_to.id}}">{{issue.assigned_to}}</a></td>
                    <td class="tbl-ui-trigger"><a href="/issue/assign/{{ issue.id }}" class="assign_issue"><div class="add_remove ui-icon ui-icon-closethick"></div></a></td>
                </tr>
            {% endfor%}
            </table>
        </div>
        <div class="dashboard_container_section">
            <h3>Pinned</h3>
            <table class="dashboard_table tbl-generic tbl-dashboard">
            {% for issue in pins%}

                {% if newest_pin != issue.created %}
                    {% set newest_pin = issue.created%}
                    <tr class="date_header tbl-rowheader"><td class="tbl-fauxth" colspan="4">{{issue.created}}</td></tr>
                {% endif %}

                <tr>
                    <td class="tbl-project"><a href="/project/{{issue.project.id}}">{{issue.project.name}}</a></td>
                    <td class="tbl-summary"><a href="/issue/{{issue.id}}">{{issue.summary}}</a></td>
                    <td class="tbl-assigned_to"><a href="/auth/user/{{issue.assigned_to.id}}">{{issue.assigned_to}}</a></td>
                    <td class="tbl-ui-trigger"><a href="/issue/pin/{{ issue.id }}" class="pin_issue"><div class="add_remove ui-icon ui-icon-closethick"></div></a></td>
                </tr>
            {% endfor%}
            </table>
        </div>
        
        <div class="dashboard_container_section">
            <h3>Subscribed</h3>
            <table class="dashboard_table tbl-generic tbl-dashboard">
            {% for issue in subscribed%}

                {% if newest_subscribed != issue.created %}
                    {% set newest_subscribed = issue.created%}
                    <tr class="date_header tbl-rowheader"><td class="tbl-fauxth" colspan="4">{{issue.created}}</td></tr>
                {% endif %}

                <tr>
                    <td class="tbl-project"><a href="/project/{{issue.project.id}}">{{issue.project.name}}</a></td>
                    <td class="tbl-summary"><a href="/issue/{{issue.id}}">{{issue.summary}}</a></td>
                    <td class="tbl-assigned_to"><a href="/auth/user/{{issue.assigned_to.id}}">{{issue.assigned_to}}</a></td>
                    <td class="tbl-ui-trigger"><a href="/issue/subscribe/{{ issue.id }}" class="subscribe_to_issue"><div class="add_remove ui-icon ui-icon-closethick"></div></a></td>
                </tr>
            {% endfor%}
            </table>
        </div>

{% endblock%}