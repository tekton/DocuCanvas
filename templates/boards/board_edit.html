<html>
<head>
    <style>
        #container{
                overflow:scroll;
                overflow-y:hidden;
                margin-right: 202px;
        }
        #bugList{
            position: fixed;
            width: 190px;
            height: 98%;
            top: 0px;
            right: 0px;
            padding: 5px;
            visibility: visible;
            overflow:scroll;
            overflow-x:hidden;
            border: 1px solid #F2F2F2;
            box-shadow: 0 1px 4px #5A5A5A;
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }
        div[id^='noteNo']{
            position: absolute;
            visibility: visible;
            border-radius: 12px;
            padding: 10px;
            background-color: white;
            border: 1px solid #F2F2F2;
            box-shadow: 0 1px 4px #5A5A5A;
        }
        div[id^='bugNote']{
            z-index: 2;
            position: absolute;
            background-color: white;
            border: 1px solid #F2F2F2;
            box-shadow: 0 1px 4px #5A5A5A;
            visibility: hidden;
            border-radius: 12px;
            padding: 10px;
        }
        #id_nodeLink_label{
            display:none;
        }
        #id_nodeLink{
            display:none;
        }
        #id_title_label{
            display:block;
        }
        #id_title{
            display:block;
        }
        #id_description_label{
            display:block;
        }
        #id_description{
            display:block;
            resize:none;
        }
        form[id^='submitForm']{
            visibility: visible;
        }
        div[id^='triangle']{
                position: absolute;
                width: 0;
                height: 0;
                border-right: 10px solid white;
                border-bottom: 10px solid transparent;
                border-top: 10px solid transparent;
                visibility: hidden;
                z-index: 3;
            }
            div[id^='triangleBorder']{
                position: absolute;
                width: 0;
                height: 0;
                border-right: 12px solid black;
                border-bottom: 12px thin transparent;
                border-top: 12px thin transparent;
                visibility: hidden;
                z-index: 0;
            }
    </style>
<body>
    <div id = 'container'></div>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.4.0.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
     <script>

            var imageWidth = {{board.width}};
            var imageHeight = {{board.height}};
            var noteCounter = 1
            var placementLock = false
            var updateLock = true
            var divToUpdate = ""
            var circleId = 0;
            // Create Background image
            var imageObj = new Image();

            // Most everything occurs inside the image onload function
            imageObj.onload = function() {
                // Create and size background image
                var bgImage = new Kinetic.Image({
                    image: imageObj,
                    width: imageWidth,
                    height: imageHeight,
                    id: 'backgroundImage',
                  });

                bgImage.on('mousedown', function(){
                    createNoteForm(noteCounter);
                    updateNoteForm();
                });

                var stage = new Kinetic.Stage({
                    container: 'container',
                    width: imageWidth,
                    height: imageHeight,
                });
                var shapesLayer = new Kinetic.Layer();
                var messageLayer = new Kinetic.Layer();
                shapesLayer.add(bgImage);
                // check to see if there are any board_node objects
                {% if board_nodes %}
                    /* Loops through board node objects and only pulls the nodes that match the board.
                    Checks the type of the node and creates a circle button and bugNote which is formatted slightly differently depending on type.
                    */
                    {% for i in board_nodes %}
                        if("{{i.board}}" == "{{board.title}}"){
                            if("{{i.nodeType}}" == 'issue'){
                                var issueSummary = ""
                                {% for issue in issues %}
                                    if({{issue.id}}=={{i.nodeLink}}){
                                        issueSummary='{{issue.summary}}'
                                    };
                                {% endfor %}
                                var newCircle = "circle" + circleId;
                                newCircle = new bugNote({{i.x}}, {{i.y}}, "{{i.nodeLink}}", "{{i.nodeType}}", issueSummary, "", circleId, {{i.id}});
                                circleId ++;
                            }else if("{{i.nodeType}}" == 'note'){
                                {% for x in board_notes %}
                                    if("{{x.id}}" == "{{i.nodeLink}}"){
                                        var newCircle = "circle" + circleId;
                                        newCircle = new bugNote({{i.x}}, {{i.y}}, "{{i.nodeLink}}", "{{i.nodeType}}", "{{x.title}}", "{{x.description|safe}}", circleId, {{i.id}});
                                        circleId ++;
                                    };
                                {% endfor %}
                            };

                        };
                {% endfor %}
                {% else %}
                    $('body').append('<p>No Board nodes</p>');
                {% endif %}

                stage.add(shapesLayer);

                //used for creating new nodes
                function createNoteForm(counter){
                    if(placementLock == false){
                        var mousePos = stage.getMousePosition();
                        var x = mousePos.x ;
                        var y = mousePos.y ;
                        var noteDivWidth = 400;
                        var noteDivY = y - 4;
                        if(imageWidth - x <= noteDivWidth){
                            var noteDivX = x - 305;
                        }else{
                            var noteDivX = x + 20;
                        };
                        if(imageHeight - y <= 70){
                            var noteDivY = y - 70;
                        }else if(y < 10){
                            var noteDivY = y + 10;
                        }else{
                            var noteDivY = y - 4;
                        };
                        placementLock = true;
                            $('body').append("<div id = 'noteNo" + counter + "' style = 'top: " + noteDivY + "px; left: " + noteDivX + "px; width: " + noteDivWidth + "px;'><form id = 'submitForm'" + counter + "' action='' method='post' enctype='multipart/form-data' onsubmit = 'return checkFormData(noteNo" + counter + ")'>{% csrf_token %} <table><tr><th><label for='id_nodeType'>NodeType:</label></th><td><select id='id_nodeType' name='nodeType' onchange = 'updateFormFields(noteNo" + counter + ")'><option value = 'note'>Note</option><option value = 'issue'>Issue</option></select></td></tr><tr><th><label for='id_nodeLink' id = 'id_nodeLink_label'>NodeLink:</label></th><td><input type='text' name='nodeLink' id='id_nodeLink'/></td></tr><tr><th><label for='id_title' id='id_title_label'>Title:</label></th><td><input type='text' name='title' id='id_title' /></td></tr><tr><th><label for='id_description' id='id_description_label'>Description:</label></th><td><textarea rows = '5' resize: none;' name='description' id='id_description' /></td></tr> </table><input type='submit' value='Submit'/><input type = 'button' value = 'Cancel' onclick = 'window.location.reload()' /> <input type = 'hidden' id ='id_board' name = 'board' value ='{{board.id}}' /><input type = 'hidden' id ='id_y' name = 'y' value =" + y + " /><input type = 'hidden' id ='id_x' name = 'x' value =" + x + " /></form></div>");


                            var circle = new Kinetic.Circle({
                                x: x,
                                y: y,
                                radius: 8,
                                fill: '#00d2ff',
                                stroke: 'black',
                                strokeWidth: 4,
                                opacity: 0.7,
                             });

                            circle.on('mouseover', function(){
                                document.body.style.cursor = 'pointer';
                            });
                            circle.on('mouseout', function(){
                                document.body.style.cursor = 'default';
                            });

                            circle.on('mousedown', function(){
                                if(placementLock == false){
                                    toggleNoteForm(counter);
                                };
                            });

                            shapesLayer.add(circle);
                            shapesLayer.draw();
                            noteCounter += 1;
                    };

                };

                //used for updating position of node
                function updateNoteForm(){
                    if(updateLock == false){
                        var formToUpdateX = divToUpdate + " #id_x";
                        var formToUpdateY = divToUpdate + " #id_y";
                        var mousePos = stage.getMousePosition();
                        var x = mousePos.x ;
                        var y = mousePos.y ;
                        var noteDivWidth = 400;
                        var noteDivY = y - 4;
                        if(imageWidth - x <= noteDivWidth){
                            var noteDivX = x - 305;
                        }else{
                            var noteDivX = x + 20;
                        };
                        if(imageHeight - y <= 70){
                            var noteDivY = y - 70;
                        }else if(y < 10){
                            var noteDivY = y + 10;
                        }else{
                            var noteDivY = y - 4;
                        };


                            $(divToUpdate).css({left:x+24,top:y-20});
                            $(formToUpdateX).val(x);
                            $(formToUpdateY).val(y);
                            updateLock = true
                            var circle = new Kinetic.Circle({
                                x: x,
                                y: y,
                                radius: 8,
                                fill: '#00d2ff',
                                stroke: 'black',
                                strokeWidth: 4,
                                opacity: 0.7,
                             });

                            circle.on('mouseover', function(){
                                document.body.style.cursor = 'pointer';
                            });
                            circle.on('mouseout', function(){
                                document.body.style.cursor = 'default';
                            });

                            circle.on('mousedown', function(){
                                if(placementLock == false){
                                };
                            });

                            shapesLayer.add(circle);
                            shapesLayer.draw();
                            noteCounter += 1;
                    };

                };

                // used for displaying nodes
                function bugNote(x, y, nodeLink, nodeType, noteTitle, noteDescription, divId, Id){
                    var tooltipId = "#" + divId;
                    var bugListId = "#bugListNo" + divId;
                    var noteDivWidth = 400;
                    var issueSelected = ""
                    var noteSelected = ""
                    var noteDivY = y - 4;
                        if(imageWidth - x <= noteDivWidth){
                            var noteDivX = x - 305;
                        }else{
                            var noteDivX = x + 26;
                        };
                        if(imageHeight - y <= 70){
                            var noteDivY = y - 70;
                        }else if(y < 10){
                            var noteDivY = y + 10;
                        }else{
                            var noteDivY = y - 15;
                        };
                    //if checks to determine what nodeLink type is selected in edit div below
                    if(nodeType=='note'){
                        noteSelected = "selected"
                    };
                    if(nodeType=='issue'){
                        issueSelected = "selected"
                    };

                    var circle = new Kinetic.Circle({
                        x: x,
                        y: y,
                        radius: 8,
                        fill: '#00d2ff',
                        stroke: 'black',
                        strokeWidth: 4,
                        name: divId,
                        opacity: 0.7,
                    });

                    circle.on('mouseover', function(){
                            document.body.style.cursor = 'pointer';
                    });
                    circle.on('mouseout', function(){
                        document.body.style.cursor = 'default';
                    });

                    circle.on('mousedown', function(){
                        toggleInfoBox(divId);
                        updateFormFields('#bugNote' +divId);
                    });
                    shapesLayer.add(circle);
                    // edit div for updating nodes
                    $('body').append("<div id = 'bugNote" + divId + "' style = 'width: " + noteDivWidth +"px; top: " + noteDivY + "px; left: " + noteDivX + "px;'><form id = 'form" + divId + "' action='' method='post' enctype='multipart/form-data' onsubmit='return checkFormData(bugNote"+ divId + ")'>{% csrf_token %} <table><tr><th><label for='id_nodeType'>NodeType:</label></th><td><select id='id_nodeType' name='nodeType' onchange='updateFormFields(bugNote" + divId + ")'><option value = 'note' " + noteSelected + ">Note</option><option value = 'issue' " + issueSelected + ">Issue</option></select></td></tr><tr><th><label for='id_nodeLink' id = 'id_nodeLink_label'>NodeLink:</label></th><td><input type='text' name='nodeLink' id='id_nodeLink' value = " + nodeLink + " /></td></tr><tr><th><label for='id_title' id='id_title_label'>Title:</label></th><td><input type='text' name='title' id='id_title' value = '"+ noteTitle + "' /></td></tr><tr><th><label for='id_description' id='id_description_label'>Description:</label></th><td><textarea rows = '5' name='description' id='id_description'>" + noteDescription + "</textarea> </td></tr><input id='id_id' type='hidden' name='id' value='" + Id + "' /></table><input type='submit' value='Submit'/><input type = 'button' value = 'Cancel' onclick = 'window.location.reload()' /><input type='button' value='Update' onclick='updateParams(" + divId + ")' /> <input type = 'hidden' id ='id_board' name = 'board' value ='{{board.id}}' /><input type = 'hidden' id ='id_y' name = 'y' value =" + y + " /><input type = 'hidden' id ='id_x' name = 'x' value =" + x + " /></form></div>");
                    $('body').append("<div id = 'triangleBorder" + divId + "'; style = 'top:" + (y-3) + "px; left: " + (x+18) + "px;'></div><div id = 'triangle" + divId + "'; style = 'top:" + (y-4) + "px; left: " + (x+19) + "px;'></div> ");
                    $('#bugList').append("<div id = 'bugListNo" + divId + "' >" + noteTitle + "<br /><a href = '#' onClick = 'toggleInfoBox(" + divId + ")'><div id = 'bugListLink" + divId + "'>Show</div></a>");
                //};
                };

                //used for toggling node divs and "triangle" attachments



            };
            imageObj.src = '/static/{{board.image}}';

            // used for toggling visibility of existing node forms
            function toggleNoteForm(divId){
                var noteFormNo = "noteNo" + divId;
                var toggleNoteFormDiv = document.getElementById(noteFormNo);
                    if(toggleNoteFormDiv.style.visibility == 'visible'){
                        toggleNoteFormDiv.style.visibility = 'hidden';
                        placementLock = false;
                    }else{
                        toggleNoteFormDiv.style.visibility = 'visible';
                        placementLock = true;
                    };
            };

            function toggleInfoBox(divId){
                    var toggleTooltipDiv = document.getElementById('bugNote' + divId);
                    var tooltipId = "#bugNote" + divId;
                    var bugListId = "#bugListNo" + divId;
                    var triangleId = "#triangle" + divId;
                    var triangleBorderId = "#triangleBorder" + divId;
                    var bugListLinkId = "#bugListLink" + divId;
                    var toggleTriangleDiv = document.getElementById(triangleId);
                        if(toggleTooltipDiv.style.visibility == 'visible'){
                            placementLock = false;
                            toggleTooltipDiv.style.visibility = 'hidden';
                            $(tooltipId).css('visibility', 'hidden');
                            $(triangleId).css('visibility', 'hidden');
                            $(triangleBorderId).css('visibility', 'hidden');
                            $(bugListId).css('background-color', 'white');
                            $(bugListLinkId).text("Show");

                        }else{
                            placementLock = true;
                            toggleTooltipDiv.style.visibility = 'visible';
                            $(tooltipId).css('visibility', 'visible');
                            $(triangleId).css('visibility', 'visible');
                            $(triangleBorderId).css('visibility', 'visible');
                            $(bugListId).css('background-color', '#ddd');
                            $(bugListLinkId).text("Hide");
                        };
                };

            // used for toggling which form fields are visible depending on nodeType
            function updateFormFields(divId){
                console.log(divId);
                if ($(divId).find('#id_nodeType').val() == 'note'){
                    $(divId).find('#id_nodeLink_label').css('display', 'none');
                    $(divId).find('#id_nodeLink').css('display', 'none');
                    $(divId).find('#id_title_label').css('display', 'block');
                    $(divId).find('#id_title').css('display', 'block');
                    $(divId).find('#id_description_label').css('display', 'block');
                    $(divId).find('#id_description').css('display', 'block');
                    console.log('NOTE');
                }else if ($(divId).find('#id_nodeType').val() == 'issue'){
                    $(divId).find('#id_nodeLink_label').css('display', 'block');
                    $(divId).find('#id_nodeLink').css('display', 'block');
                    $(divId).find('#id_title_label').css('display', 'none');
                    $(divId).find('#id_title').css('display', 'none');
                    $(divId).find('#id_description_label').css('display', 'none');
                    $(divId).find('#id_description').css('display', 'none');
                    console.log('ISSUE');
                };
            };

            // used for checking that form fields are not over the maximum length
            function checkFormData(divId){
                titleCheck = ""
                descriptionCheck = ""
                if($(divId).find('#id_title').val().length > 255 || $(divId).find('#id_description').val().length > 255){
                    if($(divId).find('#id_title').val().length > 255){
                        titleCheck = "Title cannot be more than 255 characters."
                    };
                    if($(divId).find('#id_description').val().length > 255){
                        descriptionCheck = "Description cannot be more than 255 characters."
                    };
                alert(titleCheck + " " + descriptionCheck);
                return false;
                }else{
                    return true;
                };
            };

            // helper function for updating node location
            function updateParams(div){
                updateLock = false;
                placementLock = true;
                divToUpdate = "#bugNote" + div;
                console.log(divToUpdate);
            };
         </script>

            <div id = 'bugList'><input type='button' value='Done Editing' onClick='window.location.href="/board/board_display/{{board.id}}"' /></div>

</body>
</html>