<body>
    <div id = 'container'></div>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.4.0.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
     <script>

            var imageWidth = {{board.width}};
            var imageHeight = {{board.height}};
            var noteCounter = 1
            var placementLock = false
            var updateLock = true
            var divToUpdate = ""
            var circleId = 0;
            // Create Background image
            var imageObj = new Image();

            // Most everything occurs inside the image onload function
            imageObj.onload = function() {
                // Create and size background image
                var bgImage = new Kinetic.Image({
                    image: imageObj,
                    width: imageWidth,
                    height: imageHeight,
                    id: 'backgroundImage',
                  });

                bgImage.on('mousedown', function(){
                    createNoteForm(noteCounter);
                    updateNoteForm();
                });

                var stage = new Kinetic.Stage({
                    container: 'container',
                    width: imageWidth,
                    height: imageHeight,
                });
                var shapesLayer = new Kinetic.Layer();
                var messageLayer = new Kinetic.Layer();
                shapesLayer.add(bgImage);
                // check to see if there are any board_node objects
                {% if board_nodes %}
                    /* Loops through board node objects and only pulls the nodes that match the board.  
                    Checks the type of the node and creates a circle button and bugNote which is formatted slightly differently depending on type.
                    */
                    {% for i in board_nodes %}
                        if("{{i.board}}" == "{{board.title}}"){
                            if("{{i.nodeType}}" == 'issue'){
                                var newCircle = "circle" + circleId;
                                newCircle = new bugNote({{i.x}}, {{i.y}}, "{{i.nodeLink}}", "{{i.nodeType}}", "", "", circleId, {{i.id}});
                                circleId ++;
                            }else if("{{i.nodeType}}" == 'note'){
                                {% for x in board_notes %}
                                    if("{{x.id}}" == "{{i.nodeLink}}"){
                                        var newCircle = "circle" + circleId;
                                        newCircle = new bugNote({{i.x}}, {{i.y}}, "{{i.nodeLink}}", "{{i.nodeType}}", "{{x.title}}", "{{x.description|safe}}", circleId, {{i.id}});
                                        circleId ++;
                                    };
                                {% endfor %}
                            };

                        };
                {% endfor %}
                {% else %}
                    $('body').append('<p>No Board nodes</p>');
                {% endif %}

                stage.add(shapesLayer);

                //used for creating new nodes
                function createNoteForm(counter){
                    if(placementLock == false){
                        var mousePos = stage.getMousePosition();
                        var x = mousePos.x ;
                        var y = mousePos.y ;
                        var noteDivWidth = 400;
                        var noteDivY = y - 4;
                        if(imageWidth - x <= noteDivWidth){
                            var noteDivX = x - 305;
                        }else{
                            var noteDivX = x + 20;
                        };
                        if(imageHeight - y <= 70){
                            var noteDivY = y - 70;
                        }else if(y < 10){
                            var noteDivY = y + 10;
                        }else{
                            var noteDivY = y - 4;
                        };
                        placementLock = true;
                            $('body').append("<div id = 'noteNo" + counter + "' style = 'position: absolute; top: " + noteDivY + "px; left: " + noteDivX + "px; visibility: visible; border-radius: 12px; padding: 10px; width: " + noteDivWidth + "px; background-color: gray'><form id = 'submitForm'" + counter + "' style = 'visibility: visible;' action='' method='post' enctype='multipart/form-data' onsubmit = 'return checkFormData(noteNo" + counter + ")'>{% csrf_token %} <table><tr><th><label for='id_nodeType'>NodeType:</label></th><td><select id='id_nodeType' name='nodeType' onchange = 'updateFormFields(noteNo" + counter + ")'><option value = 'note'>Note</option><option value = 'issue'>Issue</option></select></td></tr><tr><th><label for='id_nodeLink' id = 'id_nodeLink_label' style = 'display:none'>NodeLink:</label></th><td><input type='text' name='nodeLink' id='id_nodeLink' style = 'display:none'/></td></tr><tr><th><label style = 'display:block' for='id_title' id='id_title_label'>Title:</label></th><td><input style = 'display:block' type='text' name='title' id='id_title' /></td></tr><tr><th><label style = 'display:block' for='id_description' id='id_description_label'>Description:</label></th><td><textarea rows = '5' style = 'display:block; resize: none;' name='description' id='id_description' /></td></tr> </table><input type='submit' value='Submit'/><input type = 'button' value = 'Cancel' onclick = 'window.location.reload()' /> <input type = 'hidden' id ='id_board' name = 'board' value ='{{board.id}}' /><input type = 'hidden' id ='id_y' name = 'y' value =" + y + " /><input type = 'hidden' id ='id_x' name = 'x' value =" + x + " /></form></div>");
                            
                            $('body').append('<p>X: ' + x + ' Y: ' + y + '</p>');
                            var circle = new Kinetic.Circle({
                                x: x,
                                y: y,
                                radius: 8,
                                fill: '#00d2ff',
                                stroke: 'black',
                                strokeWidth: 4,
                                opacity: 0.7,
                             });

                            circle.on('mouseover', function(){
                                document.body.style.cursor = 'pointer';
                            });
                            circle.on('mouseout', function(){
                                document.body.style.cursor = 'default';
                            });

                            circle.on('mousedown', function(){
                                if(placementLock == false){
                                    toggleNoteForm(counter);
                                };
                            });

                            shapesLayer.add(circle);
                            shapesLayer.draw();
                            noteCounter += 1;
                    };

                };

                //used for updating position of node
                function updateNoteForm(){
                    if(updateLock == false){
                        var formToUpdateX = divToUpdate + " #id_x";
                        var formToUpdateY = divToUpdate + " #id_y";
                        var mousePos = stage.getMousePosition();
                        var x = mousePos.x ;
                        var y = mousePos.y ;
                        var noteDivWidth = 400;
                        var noteDivY = y - 4;
                        if(imageWidth - x <= noteDivWidth){
                            var noteDivX = x - 305;
                        }else{
                            var noteDivX = x + 20;
                        };
                        if(imageHeight - y <= 70){
                            var noteDivY = y - 70;
                        }else if(y < 10){
                            var noteDivY = y + 10;
                        }else{
                            var noteDivY = y - 4;
                        };

                        
                            $(divToUpdate).css({left:x+24,top:y-20});
                            $(formToUpdateX).val(x);
                            $(formToUpdateY).val(y);
                            updateLock = true
                            var circle = new Kinetic.Circle({
                                x: x,
                                y: y,
                                radius: 8,
                                fill: '#00d2ff',
                                stroke: 'black',
                                strokeWidth: 4,
                                opacity: 0.7,
                             });

                            circle.on('mouseover', function(){
                                document.body.style.cursor = 'pointer';
                            });
                            circle.on('mouseout', function(){
                                document.body.style.cursor = 'default';
                            });

                            circle.on('mousedown', function(){
                                if(placementLock == false){
                                };
                            });

                            shapesLayer.add(circle);
                            shapesLayer.draw();
                            noteCounter += 1;
                    };

                };

                // used for displaying nodes
                function bugNote(x, y, nodeLink, nodeType, noteTitle, noteDescription, divId, Id){
                    var tooltipId = "#" + divId;
                    var bugListId = "#bugListNo" + divId;
                    var noteDivWidth = 400;
                    var issueSelected = ""
                    var noteSelected = ""
                    //if checks to determine what nodeLink type is selected in edit div below
                    if(nodeType=='note'){
                        noteSelected = "selected"
                    };
                    if(nodeType=='issue'){
                        issueSelected = "selected"
                    };

                    var circle = new Kinetic.Circle({
                        x: x,
                        y: y,
                        radius: 8,
                        fill: '#00d2ff',
                        stroke: 'black',
                        strokeWidth: 4,
                        name: divId,
                        opacity: 0.7,
                    });

                    circle.on('mouseover', function(){
                            document.body.style.cursor = 'pointer';
                    });
                    circle.on('mouseout', function(){
                        document.body.style.cursor = 'default';
                    });

                    circle.on('mousedown', function(){
                        toggleInfoBox(divId);
                        updateFormFields('#bugNote' +divId);
                    });
                    shapesLayer.add(circle);
                    // edit div for updating nodes
                    $('body').append("<div id = 'bugNote" + divId + "' style = 'z-index: 2; width: " + noteDivWidth +"px;  position: absolute; top: " + (y - 20) + "px; left: " + (x + 24) + "px; background-color: grey; opacity: 0.9; visibility: hidden; border-radius: 12px; padding: 10px'><form id = 'form" + divId + "' action='' method='post' enctype='multipart/form-data' onsubmit='return checkFormData(bugNote"+ divId + ")'>{% csrf_token %} <table><tr><th><label for='id_nodeType'>NodeType:</label></th><td><select id='id_nodeType' name='nodeType' onchange='updateFormFields(bugNote" + divId + ")'><option value = 'note' " + noteSelected + ">Note</option><option value = 'issue' " + issueSelected + ">Issue</option></select></td></tr><tr><th><label for='id_nodeLink' id = 'id_nodeLink_label'>NodeLink:</label></th><td><input type='text' name='nodeLink' id='id_nodeLink' value = " + nodeLink + " /></td></tr><tr><th><label style = 'display:block' for='id_title' id='id_title_label'>Title:</label></th><td><input style = 'display:block' type='text' name='title' id='id_title' value = '"+ noteTitle + "' /></td></tr><tr><th><label style = 'display:block' for='id_description' id='id_description_label'>Description:</label></th><td><textarea rows = '5' style = 'display:block; resize:none;' name='description' id='id_description'>" + noteDescription + "</textarea> </td></tr><input id='id_id' type='hidden' name='id' value='" + Id + "' /></table><input type='submit' value='Submit'/><input type = 'button' value = 'Cancel' onclick = 'window.location.reload()' /><input type='button' value='Update' onclick='updateParams(" + divId + ")' /> <input type = 'hidden' id ='id_board' name = 'board' value ='{{board.id}}' /><input type = 'hidden' id ='id_y' name = 'y' value =" + y + " /><input type = 'hidden' id ='id_x' name = 'x' value =" + x + " /></form></div>");
                //};
                };

                //used for toggling node divs and "triangle" attachments
                function toggleInfoBox(divId){
                    var toggleTooltipDiv = document.getElementById('bugNote' + divId);
                    var tooltipId = "#bugNote" + divId;
                    var bugListId = "#bugListNo" + divId;
                    var triangleId = "triangle" + divId;
                    var bugListLinkId = "#bugListLink" + divId;
                    var toggleTriangleDiv = document.getElementById(triangleId);
                        if(toggleTooltipDiv.style.visibility == 'visible'){
                            placementLock = false;
                            toggleTooltipDiv.style.visibility = 'hidden';
                            $(tooltipId).css('visibility', 'hidden');
                            $(bugListId).css('background-color', 'green');
                            $(bugListLinkId).text("Show");

                        }else{
                            placementLock = true;
                            toggleTooltipDiv.style.visibility = 'visible';
                            $(tooltipId).css('visibility', 'visible');
                            $(bugListId).css('background-color', 'yellow');
                            $(bugListLinkId).text("Hide");
                        };
                };


            };
            imageObj.src = '/static/{{board.image}}';

            // used for toggling visibility of existing node forms
            function toggleNoteForm(divId){
                var noteFormNo = "noteNo" + divId;
                var toggleNoteFormDiv = document.getElementById(noteFormNo);
                    if(toggleNoteFormDiv.style.visibility == 'visible'){
                        toggleNoteFormDiv.style.visibility = 'hidden';
                        placementLock = false;
                    }else{
                        toggleNoteFormDiv.style.visibility = 'visible';
                        placementLock = true;
                    };
            };

            // used for toggling which form fields are visible depending on nodeType
            function updateFormFields(divId){
                console.log(divId);
                if ($(divId).find('#id_nodeType').val() == 'note'){
                    $(divId).find('#id_nodeLink_label').css('display', 'none');
                    $(divId).find('#id_nodeLink').css('display', 'none');
                    $(divId).find('#id_title_label').css('display', 'block');
                    $(divId).find('#id_title').css('display', 'block');
                    $(divId).find('#id_description_label').css('display', 'block');
                    $(divId).find('#id_description').css('display', 'block');
                    console.log('NOTE');
                }else if ($(divId).find('#id_nodeType').val() == 'issue'){
                    $(divId).find('#id_nodeLink_label').css('display', 'block');
                    $(divId).find('#id_nodeLink').css('display', 'block');
                    $(divId).find('#id_title_label').css('display', 'none');
                    $(divId).find('#id_title').css('display', 'none');
                    $(divId).find('#id_description_label').css('display', 'none');
                    $(divId).find('#id_description').css('display', 'none');
                    console.log('ISSUE');
                };
            };

            // used for checking that form fields are not over the maximum length
            function checkFormData(divId){
                titleCheck = ""
                descriptionCheck = ""
                if($(divId).find('#id_title').val().length > 255 || $(divId).find('#id_description').val().length > 255){
                    if($(divId).find('#id_title').val().length > 255){
                        titleCheck = "Title cannot be more than 255 characters."
                    };
                    if($(divId).find('#id_description').val().length > 255){
                        descriptionCheck = "Description cannot be more than 255 characters."
                    };
                alert(titleCheck + " " + descriptionCheck);
                return false;
                }else{
                    return true;
                };
            };

            // helper function for updating node location
            function updateParams(div){
                updateLock = false;
                placementLock = true;
                divToUpdate = "#bugNote" + div;
                console.log(divToUpdate);
            };
         </script>
</body>
