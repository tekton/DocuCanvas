<!DOCTYPE HTML>
<html>
    <head>
        <style>
            body{
                margin: 0px;
                padding: 0px;
            }
            #container{
                overflow:scroll;
                overflow-y:hidden;
                margin-right: 202px;
            }
            #bugListContainer{
                border: 1px solid #F2F2F2;
                box-shadow: 0 1px 4px #5A5A5A;

            }
            #bugList{
                position: fixed;
                width: 190px;
                height: 99%;
                top: 0px;
                right: 0px;
                padding: 5px;
                visibility: visible;
                overflow:scroll;
                overflow-x:hidden;
                border: 1px solid #F2F2F2;
                box-shadow: 0 1px 4px #5A5A5A;
                border-top-left-radius: 10px;
                border-bottom-left-radius: 10px;
            }
            div[id^='issueNote']{
                position: absolute;
                z-index: 2;
                background-color: black;
                opacity: 0.9;
                visibility: hidden;
                border-radius: 12px;
                padding: 3px;
            }
            div[id^='triangle']{
                position: absolute;
                width: 0;
                height: 0;
                border-right: 10px solid black;
                border-bottom: 10px solid transparent;
                border-top: 10px solid transparent;
                opacity: 0.9;
                visibility: hidden;
                z-index: 1;
            }
            #noteHeader{
                color: white;
                border-top-left-radius: 12px;
                border-top-right-radius: 12px;
                background-color: gray;
                text-align: left;
                position: relative;
                border-style: solid;
                border-top: 0px;
                border-right: 0px;
                border-left: 0px;
                border-bottom: solid black;
                padding: 5px;
            }
            #noteDescription{
                background-color: #585858;
                text-align: left;
                border-bottom-left-radius: 12px;
                border-bottom-right-radius: 12px;
                padding: 5px;
            }
            #issueLink{
                text-align: right;
                padding: 5px;
            }
            div[id^='bugListNo']{
                padding: 5px;
                border-style: solid;
                border-width: 1px;
                margin-bottom: 2px;
            }
        </style>
    </head>
    <body>
        <div id = "container"> </div>
         <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.4.0.min.js"></script>
          <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
          <script src = '/static/scripts/board_functions.js'></script>
           <script>

            //Test variables for placing notes, most will be contained in database when finished
            var imageWidth = {{board.width}};
            var imageHeight = {{board.height}};
            var tooltipWidth = 200;
            var tooltipHeight = 200;

            // Create Background image
            var imageObj = new Image();

            // Most everything occurs inside the image onload function
            imageObj.onload = function() {
                var bgImage = new Kinetic.Image({
                    image: imageObj,
                    width: imageWidth,
                    height: imageHeight,
                    id: 'backgroundImage',
                  });


                var stage = new Kinetic.Stage({
                    container: 'container',
                    width: imageWidth,
                    height: imageHeight,
                });
                var shapesLayer = new Kinetic.Layer();
                var messageLayer = new Kinetic.Layer();
                shapesLayer.add(bgImage);

                function issueNote(x, y, summary, description, link, divId){
                    var tooltipId = "#" + divId;
                    var bugListId = "#bugListNo" + divId;
                    issueLink = link;
                    if(issueLink != ""){
                        issueLink = "<div id='issueLink'><a style = 'color: yellow; ' href = '" + link + "' target = '_blank'>View Issue</a></div>"
                    };
                    var circle = new Kinetic.Circle({
                        x: x,
                        y: y,
                        radius: 8,
                        fill: '#00d2ff',
                        stroke: 'black',
                        strokeWidth: 4,
                    });

                    circle.on('mouseover', function(){
                        document.body.style.cursor = 'pointer';
                    });
                    circle.on('mouseout', function(){
                        document.body.style.cursor = 'default';
                    });

                    circle.on('mousedown', function(){
                        toggleInfoBox(divId);
                    });

                    shapesLayer.add(circle);
                    $('body').append("<div id = 'issueNote" + divId + "' style = 'width: " + tooltipWidth +"px;  top: " + (y - 20) + "px; left: " + (x + 24) + "px; '><div id='noteHeader'><strong>" + summary + "</strong></div><div id='noteDescription' >" + description + "</div>" + issueLink + "</div>");
                    $('body').append("<div id = 'triangle" + divId + "'; style = 'top:" + (y-10) + "px; left: " + (x+14) + "px;'></div> ");
                    $('#bugList').append("<div id = 'bugListNo" + divId + "' >" + summary + "<br /><a href = '#' onClick = 'toggleInfoBox(" + divId + ")'><div id = 'bugListLink" + divId + "'>Show</div></a>");
                };
                {% if board_nodes %}
                var circleId = 0;
					{% for i in board_nodes %}
                        if("{{i.board}}" == "{{board.title}}"){
    						var newCircle = "circle" + circleId;
                            if("{{i.nodeType}}" == "issue"){
                                {% for x in issues %}
                                    if({{x.id}} == {{i.nodeLink}}){
                                        newCircle = new issueNote({{i.x}}, {{i.y}}, "{{x.summary|linebreaksbr}}", '{{x.description|striptags|linebreaksbr}}',"/issue/"+{{i.nodeLink}}, circleId);
                                    };
                                {% endfor %}
                             }else if('{{i.nodeType}}' == 'note'){
                                {% for y in board_notes %}
                                    if("{{y.id}}" == "{{i.nodeLink}}"){
    						          newCircle = new issueNote({{i.x}}, {{i.y}},"{{y.title|linebreaksbr}}", "{{y.description|linebreaksbr}}","", circleId);
                                  };
                                {% endfor %}
                            };
    						circleId ++;
                        };
				    {% endfor %}
				{% else %}
					$('body').append('<p>No Board nodes</p>');
				{% endif %}
                stage.add(shapesLayer);
             };
            imageObj.src = '/static/{{board.image}}';

             function toggleInfoBox(divId){
                var toggleTooltipDiv = document.getElementById('issueNote'+divId);
                var tooltipId = "#issueNote" + divId;
                var bugListId = "#bugListNo" + divId;
                var triangleId = "triangle" + divId;
                var bugListLinkId = "#bugListLink" + divId;
                var toggleTriangleDiv = document.getElementById(triangleId);
                    if(toggleTooltipDiv.style.visibility == 'visible'){
                        toggleTooltipDiv.style.visibility = 'hidden';
                        toggleTriangleDiv.style.visibility = 'hidden';
                        $(tooltipId).css('visibility', 'hidden');
                        $(bugListId).css('background-color', 'white');
                        $(bugListLinkId).text("Show");

                    }else{
                        toggleTooltipDiv.style.visibility = 'visible';
                        toggleTriangleDiv.style.visibility = 'visible';
                        $(tooltipId).css('visibility', 'visible');
                        $(bugListId).css('background-color', '#ddd');
                        $(bugListLinkId).text("Hide");
                    };
            };

            function toggleBugListDiv(){
                var toggleDiv = document.getElementById('bugList');
                if(toggleDiv.style.visibility == 'visible'){
                    toggleDiv.style.visibility = 'hidden'
                    $('#toggler').text("Show");
                }else{
                    toggleDiv.style.visibility = 'visible'
                    $('#toggler').text("Hide");
                };
            };
         </script>
         <div id='bugListContainer' >
            <div id = 'bugList'></div>
        </div>
    </body>
</html>