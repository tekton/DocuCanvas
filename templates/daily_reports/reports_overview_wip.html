{% extends 'daily_reports/base.html' %}
{% load set_var %}
{% load humanize %}

{% block contextNav %}
<li><a href="{% url 'daily_reports.views.edit_report' %}">Daily Reports</a></li>
<li><a href="{% url 'daily_reports.views.view_reports' %}">View Daily Reports</a></li>
{% if user.is_superuser%}
<li><a href="{% url 'daily_reports.views.report_selection' %}">Report Selection</a></li>
{% endif %}
{% endblock %}

{% block bodyContent %}
<table class="table table-swimline dailyreports-all">
	<tbody>
		{% for user in users %}
	    	<tr>
	    		<td class="swimline-column1 swimline-rowhead">
	    			<div class="swimline-rotatewrapper">
	    				<div class="swimline-rotate">
	    					<a href="#">{{user}}</a>
	    				</div>
	    			</div>
	    		</td>
	    		<td class="swimline-column2">
    				<ul>
	    				{% for report in reports  %}
	    					{% if user == report.user %}
	    						<li>
	    							<a href="#" onClick='expandReport("reportView_{{user}}_{{forloop.counter}}")'><time datetime="{{report.date|date:'c'}}">{{report.date|date:'M j, Y'}}</time></a>
	    							<ul>
	    								<div class = 'reportView_{{user}}_{{forloop.counter}}' style='display: none'>
	    									<li>
	    										{{report.description|safe}}
	    									</li>
	    								</div>
	    							</ul>
	    						</li>
	    					{% endif %}
    					{% endfor %}
    				</ul>
	    		</td>
	    		<td class="swimline-column3">
	    			<table class="table">
	    				<tr>
	    					<td><div id='statusReport'></div></td>
	    					<td></td>
	    				</tr>
	    				<tr>
	    					<td><div id='issuesReport'></div></td>
	    					<td></td>
	    				</tr>
	    			</table>
	    		</td>
	    	</tr>
    	{% endfor %}
    </tbody>
</table>
{% endblock %}
{% block endScripts %}
<script src="//cdn.sencha.com/ext/gpl/4.2.0/ext-all-dev.js"></script>
<script>
function expandReport(div){
	var divToExpand = "." + div;
	if($(divToExpand).css('display') == 'none'){
		$(divToExpand).css('display', 'inline-block');
	}else if($(divToExpand).css('display') == 'inline-block'){
		$(divToExpand).css('display', 'none');
	};

};

var projectStore, statusStore, projectChart, statusChart, projectPanel, statusPanel;

        Ext.onReady(function(){
            function seriesClickHandler(idPrefix){
                return function(slice, eOpts){
                    var record = slice.storeItem,
                        name = record.get('name'),
                        el, parent, tables;

                    idSuffix = name.replace(/[^a-zA-Z\d\s]/g,'').replace(/\s/g,'-').replace(/-+/g,'-').trim().toLowerCase();

                    parent = $('#'+idPrefix);
                    el = $('#'+idPrefix+'-table-'+idSuffix);

                    if (!el.is(':visible')) {
                        parent.find('.table').hide();
                        el.fadeIn();
                    }
                };
            }

            projectStore = new Ext.data.JsonStore({
                fields: ['name','count'],
                data: [
                {name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5}
                ]
            });

            statusStore = new Ext.data.JsonStore({
                fields: ['name','count'],
                data: [
                {name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5},
            	{name: 'something',
            	count: 5}
                ]
            });

            projectChart = new Ext.chart.Chart({
                animate: true,
                store: projectStore,
                shadow: true,
                legend: false,
                insetPadding: 20,
                series: [
                    {
                        type: 'pie',
                        field: 'count',
                        showInLegend: true,
                        highlight: false,
                        donut: false,
                        label: {
                            field: 'name',
                            display: 'rotate',
                            contrast: true,
                            font: '14px Arial'
                        },
                        listeners: {
                            itemmousedown: seriesClickHandler('projectbreakdown')
                        }
                    }
                ]
            });

            statusChart = new Ext.chart.Chart({
                animate: true,
                store: statusStore,
                shadow: true,
                legend: false,
                insetPadding: 20,
                axes: [
                    {
                        type: 'Numeric',
                        position: 'left',
                        fields: 'count',
                        grid: true,
                        minimum: 0
                    },
                    {
                        type: 'Category',
                        position: 'bottom',
                        fields: 'name'
                    }
                ],
                series: [
                    {
                        type: 'column',
                        axis: 'left',
                        hightlight: false,
                        xField: 'name',
                        yField: 'count',
                        listeners: {
                            itemmousedown: seriesClickHandler('statusbreakdown')
                        }
                    }
                ]
            });

            projectPanel = new Ext.Panel({
                width: 260,
                height: 130,
                layout: 'fit',
                items: projectChart,
                renderTo: Ext.get('issuesReport')
            })

            statusPanel = new Ext.Panel({
                width: 260,
                height: 130,
                layout: 'fit',
                items: statusChart,
                renderTo: Ext.get('statusReport')
            })
        });
</script>
{% endblock %}