{% extends 'daily_reports/base.html' %}
{% load set_var %}
{% load humanize %}

{% block contextNav %}
<li><a href="{% url 'daily_reports.views.edit_report' %}">Daily Reports</a></li>
<li><a href="{% url 'daily_reports.views.view_reports' %}">View Daily Reports</a></li>
{% if user.is_superuser%}
<li><a href="{% url 'daily_reports.views.report_selection' %}">Report Selection</a></li>
{% endif %}
{% endblock %}

{% block bodyContent %}
<table class="table table-swimline dailyreports-all">
	<tbody>
		{% for user in users %}
	    	<tr>
	    		<td class="swimline-column1 swimline-rowhead">
	    			<div class="swimline-rotatewrapper">
	    				<div class="swimline-rotate">
	    					<a href="{% url 'auth.views.user_overview' user.id %}">{{user}}</a>
	    				</div>
	    			</div>
	    		</td>
	    		<td class="swimline-column2">
                    <div id="list-dailyreport-{{user|slugify|lower}}" class="dailyreport-list">
                        <div id="accordion-dailyreport-{{user|slugify|lower}}" class="accordion">
                            {% for report in reports  %}
                                {% if user == report.user %}
                                    <div class="accordion-group">
                                        <div class="accordion-heading">
                                            <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion-dailyreport-{{user|slugify|lower}}" href="#dailyreport-{{user|slugify|lower}}-{{report.date|date:'c'|slugify}}">
                                                <time datetime="{{report.date|date:'c'}}">{{report.date|date:'M j, Y'}}</time>
                                            </a>
                                        </div>
                                        <div id="dailyreport-{{user|slugify|lower}}-{{report.date|date:'c'|slugify}}" class="accordion-body collapse">
                                            <div class="accordion-inner">
                                                {{report.description|safe}}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
	    		</td>
	    		<td class="swimline-column3">
                    <div id="chart-status-{{user|slugify|lower}}" class="dailyreport-chart"></div>
	    		</td>
                <td class="swimline-column4">
                    <div id="chart-project-{{user|slugify|lower}}" class="dailyreport-chart"></div>
                </td>
	    	</tr>
    	{% endfor %}
    </tbody>
</table>
{% endblock %}

{% block endScripts %}
<script src="//cdn.sencha.com/ext/gpl/4.2.0/ext-all.js"></script>

{% regroup newsfeeditems by user as NewsfeedItemsByUser %}
<script>
    var data = {};
    {% for newsfeeditem in NewsfeedItemsByUser %}
        data['{{newsfeeditem.grouper|slugify|lower}}'] = {
            "status": [
                {% regroup newsfeeditem.list|dictsort:"new_value" by field_change as NewsfeedItemsByUserByFieldChange %}
                {% for itembyfieldchange in NewsfeedItemsByUserByFieldChange %}
                    {% if itembyfieldchange.grouper == 'status' %}
                        {% regroup itembyfieldchange.list by new_value as NewsfeedItemsByUserByFieldChangeByNewValue %}
                        {% for item in NewsfeedItemsByUserByFieldChangeByNewValue %}
                            {
                                "name": "{{item.grouper|escapejs}}",
                                "count": {{item.list|length}}
                            }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    {% endif %}
                {% endfor %}
            ],
            "project": [
                {% regroup newsfeeditem.list by project as IssuesUpdatedByUserByProject %}
                {% for issue in IssuesUpdatedByUserByProject %}
                    {
                        "name": "{{issue.grouper|escapejs}}",
                        "count": {{issue.list|length}}
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        };
    {% endfor %}

    Ext.onReady(function(){
        var chartWidth = 300,
            chartHeight = 300;

        Ext.Object.each(data,function(user,dataSet,allData){

            /* Issues by Status - Column Chart */
            new Ext.Panel({
                width: chartWidth,
                height: chartHeight,
                layout: 'fit',
                items: new Ext.chart.Chart({
                    animate: true,
                    store: new Ext.data.JsonStore({
                        fields: ['name','count'],
                        data: dataSet.status
                    }),
                    shadow: true,
                    legend: false,
                    insetPadding: 20,
                    axes: [
                        {
                            type: 'Numeric',
                            position: 'left',
                            fields: 'count',
                            grid: true,
                            minimum: 0
                        },
                        {
                            type: 'Category',
                            position: 'bottom',
                            fields: 'name',
                            label: {
                                rotate: {
                                    degrees: -90
                                },
                                renderer: function(label){
                                    var text = '';
                                    switch (label) {
                                        case 'active':
                                            text = 'Active';
                                            break;
                                        case 'duplicate':
                                            text = 'Duplicate';
                                            break;
                                        case 'fixed':
                                            text = 'Fixed';
                                            break;
                                        case 'not_a_bug':
                                            text = 'Not a Bug';
                                            break;
                                        case 'unverified':
                                            text = 'Unverified';
                                            break;
                                        case 'wont_fix':
                                            text = 'Won\'t Fix';
                                            break;
                                        case 'retest':
                                            text = 'Retest';
                                            break;
                                        default:
                                            text = label;
                                            break;
                                    }
                                    return text;
                                }
                            }
                        }
                    ],
                    series: [
                        {
                            type: 'column',
                            axis: 'left',
                            hightlight: false,
                            xField: 'name',
                            yField: 'count',
                            renderer: function(sprite,record,attributes,index,store) {
                                var color = '#999999';

                                switch (record.get('name')) {
                                    case 'not_a_bug':
                                    case 'wont_fix':
                                    case 'duplicate':
                                        color = '#3A87AD';
                                        break;

                                    case 'active':
                                    case 'retest':
                                        color = '#F89406';
                                        break;

                                    case 'fixed':
                                        color = '#468847';
                                        break;
                                }

                                return Ext.apply(attributes,{
                                    fill: color
                                })
                            }
                        }
                    ]
                }),
                renderTo: Ext.get('chart-status-'+user)
            });
        
            /* Issues by Project - Pie Chart */
            new Ext.Panel({
                width: chartWidth,
                height: chartHeight,
                layout: 'fit',
                items: new Ext.chart.Chart({
                    animate: true,
                    store: new Ext.data.JsonStore({
                        fields: ['name','count'],
                        data: dataSet.project
                    }),
                    shadow: true,
                    legend: false,
                    insetPadding: 20,
                    series: [
                        {
                            type: 'pie',
                            field: 'count',
                            showInLegend: true,
                            highlight: false,
                            donut: false,
                            label: {
                                field: 'name',
                                display: 'rotate',
                                contrast: true,
                                font: '14px Arial'
                            }
                        }
                    ]
                }),
                renderTo: Ext.get('chart-project-'+user)
            });
        });
    });
</script>
{% endblock %}